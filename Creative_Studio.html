<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Créatif Pro - Correctif</title>
    <style>
        :root {
            --bg-dark: #121212; --bg-panel: #1e1e1e; --primary: #bb86fc;
            --secondary: #03dac6; --accent-red: #cf6679; --text-main: #e0e0e0;
            --text-muted: #a0a0a0; --border: #333; --active-mode: #3700b3;
        }


        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }


        header { background-color: var(--bg-panel); padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        
        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 300px; background-color: var(--bg-panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        
        .mode-selector { display: flex; flex-direction: column; gap: 8px; }
        .mode-btn { 
            background: #2c2c2c; color: var(--text-muted); border: 1px solid var(--border); 
            padding: 12px; text-align: left; border-radius: 6px; cursor: pointer; transition: 0.3s;
            font-weight: bold; display: flex; align-items: center; gap: 10px;
        }
        .mode-btn:hover { background: #333; }
        .mode-btn.active { background: var(--active-mode); color: white; border-color: var(--primary); }


        /* PANNEAUX D'OPTIONS */
        .tool-group { display: none; flex-direction: column; gap: 15px; background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid var(--secondary); }
        .tool-group.visible { display: flex; }


        .editor-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; padding: 20px; background-color: #161616; overflow: auto; }
        
        /* VISUALS */
        canvas#main-canvas { border: 1px solid var(--border); max-width: 95%; max-height: 80vh; background: white; cursor: crosshair; display: none; }
        video#video-preview, textarea#text-editor { max-width: 95%; max-height: 70vh; display: none; }
        textarea#text-editor { width: 90%; height: 80%; background: #fff; color: #000; padding: 20px; font-size: 1.1rem; border-radius: 8px; }


        /* DICTAPHONE UI */
        #audio-center-ui { display: none; flex-direction: column; align-items: center; gap: 25px; width: 100%; }
        #visualizer { width: 90%; height: 180px; background: #000; border-radius: 12px; border: 1px solid var(--primary); }
        .rec-controls { display: flex; gap: 20px; }
        .btn-rec { width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 1.5rem; }
        #btn-start-rec { background: var(--accent-red); color: white; }
        #btn-stop-rec { background: #fff; color: #000; display: none; }
        #audio-preview { margin-top: 20px; display: none; filter: invert(0.9); }


        .btn { background: var(--primary); color: #000; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .filter-btn { background: #444; color: white; border: none; padding: 6px; font-size: 0.75rem; border-radius: 4px; cursor: pointer; }
        label { font-size: 0.8rem; color: var(--secondary); font-weight: bold; }
    </style>
</head>
<body>


    <header>
        <h1 style="color: var(--primary); letter-spacing: 1px;">STUDIO CRÉATIF</h1>
        <div id="file-actions" style="display:none; gap: 10px;">
            <button id="import-btn" class="btn" style="background:transparent; border:1px solid var(--primary); color:var(--primary);" onclick="document.getElementById('file-input').click()">📂 Importer</button>
            <button class="btn" onclick="saveWork()">💾 Sauvegarder</button>
        </div>
    </header>


    <div class="workspace">
        <aside class="sidebar">
            <div class="mode-selector">
                <button class="mode-btn" onclick="switchMode('audio')" id="mode-audio">🎙️ Mode Dictaphone</button>
                <button class="mode-btn" onclick="switchMode('image')" id="mode-image">🖼️ Image & Dessin</button>
                <button class="mode-btn" onclick="switchMode('video')" id="mode-video">🎬 Vidéo</button>
                <button class="mode-btn" onclick="switchMode('text')" id="mode-text">📝 Texte</button>
            </div>


            <hr style="border: 0; border-top: 1px solid var(--border); margin: 10px 0;">


            <div id="tools-image" class="tool-group">
                <label>🎨 Filtres</label>
                <div class="filter-grid">
                    <button class="filter-btn" onclick="setFilter('none')">Normal</button>
                    <button class="filter-btn" onclick="setFilter('grayscale(100%)')">N&B</button>
                    <button class="filter-btn" onclick="setFilter('sepia(100%)')">Sépia</button>
                    <button class="filter-btn" onclick="setFilter('invert(100%)')">Négatif</button>
                </div>
                <label>✏️ Taille Pinceau</label>
                <input type="range" id="draw-size" min="1" max="40" value="5">
                <label>🌈 Couleur</label>
                <input type="color" id="draw-color" value="#bb86fc" style="width: 100%; height: 30px; cursor:pointer;">
                <button class="btn" style="background:#444; color:white; font-size: 0.8rem;" onclick="clearCanvas()">🗑️ Effacer Dessins</button>
            </div>


            <div id="tools-audio" class="tool-group">
                <p style="font-size:0.8rem; color:var(--text-muted)">Utilisez les contrôles au centre de l'écran pour enregistrer votre voix.</p>
                <label>Statut</label>
                <div id="status-label" style="font-size:0.9rem; color:var(--secondary)">Prêt</div>
            </div>


            <div id="tools-video" class="tool-group">
                <label>⏩ Vitesse Lecture</label>
                <input type="range" id="vid-speed" min="0.5" max="2" step="0.1" value="1" oninput="updateVideo()">
                <span id="speed-val">1.0x</span>
            </div>


            <div id="tools-text" class="tool-group">
                <p style="font-size:0.8rem; color:var(--text-muted)">Éditeur de texte brut. Les modifications sont enregistrées dans le fichier exporté.</p>
            </div>
        </aside>


        <main class="editor-area">
            <div id="empty-state" style="text-align:center">
                <h2>Bienvenue au Studio</h2>
                <p style="color:var(--text-muted)">Sélectionnez un mode à gauche pour commencer</p>
            </div>


            <canvas id="main-canvas"></canvas>


            <div id="audio-center-ui">
                <canvas id="visualizer"></canvas>
                <div class="rec-controls">
                    <button id="btn-start-rec" class="btn-rec">⏺️</button>
                    <button id="btn-stop-rec" class="btn-rec">⏹️</button>
                </div>
                <audio id="audio-preview" controls></audio>
            </div>


            <video id="video-preview" controls></video>
            <textarea id="text-editor" spellcheck="false"></textarea>
        </main>
    </div>


    <input type="file" id="file-input" style="display:none">


    <script>
        let currentMode = null;
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let baseImage = null;


        let audioCtx, analyser, dataArray, animationId, mediaRecorder, audioChunks = [];


        function switchMode(mode) {
            currentMode = mode;
            
            // 1. Activer le bouton dans la sidebar
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            
            // 2. Afficher le panneau d'options correspondant
            document.querySelectorAll('.tool-group').forEach(g => g.classList.remove('visible'));
            const targetTool = document.getElementById('tools-' + mode);
            if(targetTool) targetTool.classList.add('visible');


            // 3. Afficher les actions globales
            document.getElementById('file-actions').style.display = 'flex';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('import-btn').style.display = (mode === 'audio') ? 'none' : 'inline-block';


            fullReset();


            // 4. Activer la zone d'affichage
            if(mode === 'audio') document.getElementById('audio-center-ui').style.display = 'flex';
            if(mode === 'image') canvas.style.display = 'block';
            if(mode === 'video') document.getElementById('video-preview').style.display = 'block';
            if(mode === 'text') document.getElementById('text-editor').style.display = 'block';
        }


        function fullReset() {
            [canvas, document.getElementById('video-preview'), document.getElementById('text-editor'), document.getElementById('audio-center-ui')].forEach(el => el.style.display = 'none');
            
            const aud = document.getElementById('audio-preview');
            aud.pause(); aud.style.display = 'none';
            document.getElementById('video-preview').pause();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.filter = "none";
            document.getElementById('text-editor').value = "";
            cancelAnimationFrame(animationId);
            if(audioCtx) audioCtx.close();
        }


        // --- AUDIO VISUALIZER ---
        async function setupVisualizer(stream) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 128;
            source.connect(analyser);


            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            const vCanvas = document.getElementById('visualizer');
            const vCtx = vCanvas.getContext('2d');


            function draw() {
                animationId = requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                vCtx.fillStyle = '#121212';
                vCtx.fillRect(0, 0, vCanvas.width, vCanvas.height);
                let barWidth = (vCanvas.width / bufferLength) * 2;
                let x = 0;
                for(let i = 0; i < bufferLength; i++) {
                    let barHeight = dataArray[i];
                    vCtx.fillStyle = `hsl(${280 + barHeight/5}, 70%, 70%)`;
                    vCtx.fillRect(x, vCanvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 2;
                }
            }
            draw();
        }


        document.getElementById('btn-start-rec').onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupVisualizer(stream);
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/mp3' });
                const aud = document.getElementById('audio-preview');
                aud.src = URL.createObjectURL(blob);
                aud.style.display = 'block';
            };
            mediaRecorder.start();
            document.getElementById('btn-start-rec').style.display = 'none';
            document.getElementById('btn-stop-rec').style.display = 'flex';
            document.getElementById('status-label').innerText = "🔴 Enregistrement...";
        };


        document.getElementById('btn-stop-rec').onclick = () => {
            mediaRecorder.stop();
            document.getElementById('btn-start-rec').style.display = 'flex';
            document.getElementById('btn-stop-rec').style.display = 'none';
            document.getElementById('status-label').innerText = "Prêt";
        };


        // --- FICHIERS ---
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (currentMode === 'image') {
                const reader = new FileReader();
                reader.onload = (event) => {
                    baseImage = new Image();
                    baseImage.onload = () => {
                        canvas.width = baseImage.width; canvas.height = baseImage.height;
                        ctx.drawImage(baseImage, 0, 0);
                    };
                    baseImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else if (currentMode === 'video') {
                document.getElementById('video-preview').src = URL.createObjectURL(file);
            } else if (currentMode === 'text') {
                const reader = new FileReader();
                reader.onload = (ev) => document.getElementById('text-editor').value = ev.target.result;
                reader.readAsText(file);
            }
        };


        // --- DESSIN ---
        canvas.onmousedown = () => drawing = true;
        canvas.onmouseup = () => { drawing = false; ctx.beginPath(); };
        canvas.onmousemove = (e) => {
            if (!drawing || currentMode !== 'image') return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = document.getElementById('draw-size').value;
            ctx.lineCap = "round";
            ctx.strokeStyle = document.getElementById('draw-color').value;
            ctx.lineTo((e.clientX - rect.left) * (canvas.width/rect.width), (e.clientY - rect.top) * (canvas.height/rect.height));
            ctx.stroke(); ctx.beginPath();
            ctx.moveTo((e.clientX - rect.left) * (canvas.width/rect.width), (e.clientY - rect.top) * (canvas.height/rect.height));
        };


        function setFilter(f) { canvas.style.filter = f; }
        function clearCanvas() { if(baseImage) ctx.drawImage(baseImage, 0, 0); else ctx.clearRect(0,0,canvas.width,canvas.height); }
        function updateVideo() { 
            const speed = document.getElementById('vid-speed').value;
            document.getElementById('video-preview').playbackRate = speed;
            document.getElementById('speed-val').innerText = speed + "x";
        }


        function saveWork() {
            let link = document.createElement('a');
            if(currentMode === 'image') {
                const tempCanvas = document.createElement('canvas');
                const tCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
                tCtx.filter = getComputedStyle(canvas).filter;
                tCtx.drawImage(canvas, 0, 0);
                link.download = 'studio-image.png';
                link.href = tempCanvas.toDataURL();
            } else if(currentMode === 'text') {
                const blob = new Blob([document.getElementById('text-editor').value], {type: 'text/plain'});
                link.download = 'studio-note.txt';
                link.href = URL.createObjectURL(blob);
            } else {
                alert("Pour l'audio et la vidéo, utilisez les contrôles natifs (clic droit ou menu du lecteur) pour enregistrer.");
                return;
            }
            link.click();
        }
    </script>
</body>
</html>